name: Deploy Workflows to All Repos

on:
  push:
    branches: [main]
    paths:
      - 'workflow-templates/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy workflows to all repos
        env:
          GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
        run: |
          # Organization의 모든 레포 (본 레포 제외)
          repos=$(gh repo list play597 --limit 100 --json name -q '.[].name' | grep -v '^\.github$')

          for repo in $repos; do
            echo "=== Deploying to play597/$repo ==="

            for template in workflow-templates/*.yml; do
              filename=$(basename "$template")

              # base64 인코딩 (macOS와 Linux 호환)
              content_base64=$(base64 -w 0 < "$template" 2>/dev/null || base64 < "$template" | tr -d '\n')

              # 기존 파일 확인
              existing=$(gh api "repos/play597/$repo/contents/.github/workflows/$filename" 2>/dev/null || echo "")

              if [ -n "$existing" ] && echo "$existing" | grep -q '"sha"'; then
                # 파일 존재 - 업데이트
                sha=$(echo "$existing" | grep -o '"sha": "[^"]*"' | head -1 | cut -d'"' -f4)
                echo "  Updating: $filename (sha: $sha)"

                result=$(gh api -X PUT "repos/play597/$repo/contents/.github/workflows/$filename" \
                  -f message="chore: sync workflow from org template" \
                  -f content="$content_base64" \
                  -f sha="$sha" 2>&1) && echo "  Success" || echo "  Failed: $result"
              else
                # 파일 없음 - 생성
                echo "  Creating: $filename"

                result=$(gh api -X PUT "repos/play597/$repo/contents/.github/workflows/$filename" \
                  -f message="chore: add workflow from org template" \
                  -f content="$content_base64" 2>&1) && echo "  Success" || echo "  Failed: $result"
              fi
            done

            echo ""
          done
