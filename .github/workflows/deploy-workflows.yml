name: Deploy Workflows to All Repos

on:
  push:
    branches: [main]
    paths:
      - 'workflow-templates/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Deploy workflows to all repos
        env:
          GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
        run: |
          # Organization의 모든 레포 (본 레포 제외)
          repos=$(gh repo list play597 --limit 100 --json name -q '.[].name' | grep -v '^\.github$')

          for repo in $repos; do
            echo "=== Deploying to play597/$repo ==="

            # 레포 클론 (토큰 포함 URL)
            rm -rf /tmp/repo
            git clone --depth 1 "https://x-access-token:${GH_TOKEN}@github.com/play597/$repo.git" /tmp/repo 2>/dev/null || continue

            cd /tmp/repo

            # .github/workflows 폴더 생성
            mkdir -p .github/workflows

            # 템플릿 복사
            for template in $GITHUB_WORKSPACE/workflow-templates/*.yml; do
              filename=$(basename "$template")
              cp "$template" ".github/workflows/$filename"
              echo "  Copied: $filename"
            done

            # 변경사항 있으면 커밋 & 푸시
            if [ -n "$(git status --porcelain)" ]; then
              git add .github/workflows/
              git commit -m "chore: sync workflows from org template"
              git push
              echo "  Pushed changes"
            else
              echo "  No changes"
            fi

            cd - > /dev/null
            echo ""
          done
